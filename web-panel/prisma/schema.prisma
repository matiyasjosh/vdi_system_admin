generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  FACULTY
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String   @unique
  password      String
  role          Role      @default(FACULTY)

  labId         String?
  lab           Lab?       @relation(fields: [labId], references: [id])
  
  sessions      Session[]
  logs          Log[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  ipAddress    String?
  userAgent    String?
  expires      DateTime
  sessionToken String   @unique

  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("sessions")
}

model Lab {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?

  users       User[]
  vms         VM[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([name])
  @@map("labs")
}

model VM {
  id           String   @id @default(cuid())
  proxmoxId    Int      @unique
  hostname     String
  ipAddress    String   @unique
  
  labId        String
  lab          Lab      @relation(fields: [labId], references: [id])

  packages     VMPackage[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([proxmoxId])
  @@index([hostname])
  @@index([ipAddress])

  @@map("vms")
}

model Package {
  id          String   @id @default(cuid())
  name        String   @unique
  version     String?
  description String?
  
  vmStatuses  VMPackage[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([name])
  @@map("packages")
}

enum InstallStatus {
  INSTALLED
  PENDING
  FAILED
  MISSING
}

model VMPackage {
  id        String        @id @default(cuid())
  status    InstallStatus @default(MISSING)

  vmId      String
  packageId String

  vm        VM      @relation(fields: [vmId], references: [id], onDelete: Cascade)
  package   Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([vmId, packageId])
  @@index([vmId])
  @@index([status])
  
  @@map("vm_packages")
}

enum LogSeverity {
  INFO      
  WARNING   
  ERROR     
  FATAL     
}

enum LogType {
  AUTH_LOGIN_SUCCESS
  AUTH_LOGIN_FAILED
  AUTH_LOGOUT
  AUTH_ROLE_CHANGED        

  VM_PROVISIONED           
  VM_STARTED
  VM_STOPPED
  VM_REBOOTED
  VM_DESTROYED             
  VM_SNAPSHOT_CREATED
  VM_SNAPSHOT_RESTORED

  NIX_SYNC_REQUESTED       
  NIX_BUILD_SUCCESS        
  NIX_BUILD_FAILED         
  PACKAGE_STATE_MISMATCH  
  
  LAB_CREATED
  LAB_UPDATED
  LAB_DELETED

  PROXMOX_API_ERROR        
  NETWORK_DISCONNECT       
}

model Log {
  id          String      @id @default(cuid())
  type        LogType
  severity    LogSeverity @default(INFO)
  
  message     String      @db.Text
  details     Json?       

  userId      String?
  user        User?       @relation(fields:[userId], references:[id], onDelete: SetNull)
  
  ipAddress   String?     

  targetId    String?     
  targetName  String?     

  createdAt   DateTime    @default(now())

  @@index([type])
  @@index([severity])
  @@index([userId])
  @@index([ipAddress])
  @@index([targetId])
  @@index([targetName])

  @@map("logs")
}